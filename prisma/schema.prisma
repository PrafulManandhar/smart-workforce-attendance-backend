generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CompanyStatus {
  DRAFT
  ACTIVE_TRIAL
  ACTIVE_PAID
  SUSPENDED
}

enum Role {
  SUPER_ADMIN
  COMPANY_ADMIN
  MANAGER
  EMPLOYEE
}

enum ShiftType {
  MORNING
  EVENING
  NIGHT
  DAY
  OTHER
}

enum AttendanceEventType {
  CHECK_IN
  BREAK_IN
  BREAK_OUT
  CHECK_OUT
}

enum LocationSource {
  OFFICE
  HOME
  REMOTE
}

enum ShiftStatus {
  DRAFT
  PUBLISHED
  CANCELLED
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum AuditEventType {
  INVITE_CREATED
  INVITE_RESENT
  INVITE_REVOKED
  INVITE_ACCEPTED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model Company {
  id       String  @id @default(cuid())
  name     String?
  code     String? @unique
  timezone String  @default("Australia/Sydney")
  isActive Boolean @default(true)

  status CompanyStatus @default(DRAFT)

  trialStartAt  DateTime?
  trialEndAt    DateTime?
  employeeLimit Int?

  estimatedEmployeeRange String?
  currentRosteringMethod String?
  phoneNumber            String?
  jobTitle               String?
  onboardingCompletedAt  DateTime?

  annualLeaveRatio Float?
  sickLeaveRatio   Float?

  earlyCheckInMinutes Int? @default(30)

  users           User[]
  employees       EmployeeProfile[]
  shifts          Shift[]
  workLocations   WorkLocation[]
  employeeInvites EmployeeInvite[]
  auditLogs       AuditLog[]             @relation("CompanyAuditLogs")
  availabilities  EmployeeAvailability[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String
  role         Role
  isActive     Boolean @default(true)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  employeeProfile        EmployeeProfile?
  createdEmployeeInvites EmployeeInvite[]
  actorAuditLogs         AuditLog[]                     @relation("UserAuditLogs")
  createdAvailabilities  EmployeeAvailability[]         @relation("AvailabilityCreatedBy")
  updatedAvailabilities  EmployeeAvailability[]         @relation("AvailabilityUpdatedBy")
  createdOverrides       EmployeeAvailabilityOverride[] @relation("OverrideCreatedBy")

  hashedRefreshToken     String?
  resetPasswordTokenHash String?
  resetPasswordExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmployeeInvite {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  invitedEmail String
  invitedName  String?

  role Role @default(EMPLOYEE)

  tokenHash      String
  tokenExpiresAt DateTime

  status InviteStatus @default(PENDING)

  createdByUserId String
  createdByUser   User   @relation(fields: [createdByUserId], references: [id])

  createdAt  DateTime  @default(now())
  acceptedAt DateTime?
  revokedAt  DateTime?

  auditLogs AuditLog[] @relation("InviteAuditLogs")

  @@unique([companyId, invitedEmail, status])
  @@index([companyId])
  @@index([invitedEmail])
  @@index([status])
  @@index([tokenExpiresAt])
}

model AuditLog {
  id String @id @default(cuid())

  companyId String?
  company   Company? @relation("CompanyAuditLogs", fields: [companyId], references: [id])

  actorUserId String?
  actorUser   User?   @relation("UserAuditLogs", fields: [actorUserId], references: [id])

  inviteId String?
  invite   EmployeeInvite? @relation("InviteAuditLogs", fields: [inviteId], references: [id])

  eventType AuditEventType
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([actorUserId])
  @@index([inviteId])
  @@index([eventType])
}

model EmployeeProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  firstName String
  lastName  String
  position  String?

  hasWFHPermission  Boolean @default(false)
  homeLatitude      Float?
  homeLongitude     Float?
  isSummaryRequired Boolean @default(false)

  managerId String?

  shifts             Shift[]
  attendanceSessions AttendanceSession[]
  availabilities     EmployeeAvailability[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkLocation {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  name      String
  address   String?
  latitude  Float?
  longitude Float?
  isActive  Boolean @default(true)

  shifts Shift[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Shift {
  id                 String          @id @default(cuid())
  employeeId         String
  employee           EmployeeProfile @relation(fields: [employeeId], references: [id])
  companyId          String
  company            Company         @relation(fields: [companyId], references: [id])
  workLocationId     String?
  workLocation       WorkLocation?   @relation(fields: [workLocationId], references: [id])
  startAt            DateTime
  endAt              DateTime
  type               ShiftType
  status             ShiftStatus     @default(PUBLISHED)
  paidBreakMinutes   Int?            @default(0)
  unpaidBreakMinutes Int?            @default(0)

  attendanceSessions AttendanceSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AttendanceSession {
  id                 String          @id @default(cuid())
  employeeId         String
  employee           EmployeeProfile @relation(fields: [employeeId], references: [id])
  shiftId            String?
  shift              Shift?          @relation(fields: [shiftId], references: [id])
  actualStartAt      DateTime
  actualEndAt        DateTime?
  effectiveStartAt   DateTime
  effectiveEndAt     DateTime?
  wasEarlyCheckIn    Boolean         @default(false)
  totalWorkedMinutes Int?
  summary            String?

  events AttendanceEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AttendanceEvent {
  id        String              @id @default(cuid())
  sessionId String
  session   AttendanceSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  type      AttendanceEventType
  createdAt DateTime            @default(now())

  locationSnapshot LocationSnapshot?
}

model LocationSnapshot {
  id             String          @id @default(cuid())
  eventId        String          @unique
  event          AttendanceEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  latitude       Float
  longitude      Float
  source         LocationSource
  distanceMeters Float?

  createdAt DateTime @default(now())
}

model EmployeeAvailability {
  id         String          @id @default(cuid())
  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  companyId  String
  company    Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  effectiveFrom DateTime?
  effectiveTo   DateTime?

  windows   EmployeeAvailabilityWindow[]
  overrides EmployeeAvailabilityOverride[]

  createdByUserId String?
  createdByUser   User?   @relation("AvailabilityCreatedBy", fields: [createdByUserId], references: [id])
  updatedByUserId String?
  updatedByUser   User?   @relation("AvailabilityUpdatedBy", fields: [updatedByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, companyId])
  @@index([employeeId])
  @@index([companyId])
  @@index([effectiveFrom])
  @@index([effectiveTo])
}

model EmployeeAvailabilityWindow {
  id             String               @id @default(cuid())
  availabilityId String
  availability   EmployeeAvailability @relation(fields: [availabilityId], references: [id], onDelete: Cascade)
  dayOfWeek      DayOfWeek
  startTime      String // HH:mm format (e.g., "09:00")
  endTime        String // HH:mm format (e.g., "17:00")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([availabilityId])
  @@index([dayOfWeek])
}

model EmployeeAvailabilityOverride {
  id             String               @id @default(cuid())
  availabilityId String
  availability   EmployeeAvailability @relation(fields: [availabilityId], references: [id], onDelete: Cascade)
  overrideDate   DateTime // Specific date this override applies to
  startTime      String? // HH:mm format, null means unavailable all day
  endTime        String? // HH:mm format, null means unavailable all day
  reason         String // Required reason for the override

  createdByUserId String?
  createdByUser   User?   @relation("OverrideCreatedBy", fields: [createdByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([availabilityId, overrideDate])
  @@index([availabilityId])
  @@index([overrideDate])
}
