generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CompanyStatus {
  DRAFT
  ACTIVE_TRIAL
  ACTIVE_PAID
  SUSPENDED
}

enum Role {
  SUPER_ADMIN
  COMPANY_ADMIN
  MANAGER
  EMPLOYEE
}

enum ShiftType {
  MORNING
  EVENING
  NIGHT
  DAY
  OTHER
}

enum AttendanceEventType {
  CHECK_IN
  BREAK_IN
  BREAK_OUT
  CHECK_OUT
}

enum LocationSource {
  OFFICE
  HOME
  REMOTE
}

enum ShiftStatus {
  DRAFT
  PUBLISHED
  CANCELLED
}

model Company {
  id        String        @id @default(cuid())
  name      String?
  code      String?       @unique
  timezone  String        @default("Australia/Sydney")
  isActive  Boolean       @default(true)

  status    CompanyStatus @default(DRAFT)

  trialStartAt  DateTime?
  trialEndAt    DateTime?
  employeeLimit Int?

  estimatedEmployeeRange String?
  currentRosteringMethod String?
  phoneNumber            String?
  jobTitle               String?
  onboardingCompletedAt  DateTime?

  annualLeaveRatio Float?
  sickLeaveRatio   Float?

  earlyCheckInMinutes Int? @default(30)

  users     User[]
  employees EmployeeProfile[]
  shifts    Shift[]
  workLocations WorkLocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id        String  @id @default(cuid())
  email     String  @unique
  passwordHash String
  role      Role
  isActive  Boolean @default(true)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  employeeProfile EmployeeProfile?

  hashedRefreshToken String?
  resetPasswordTokenHash String?
  resetPasswordExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmployeeProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])

  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])

  firstName       String
  lastName        String
  position        String?

  hasWFHPermission  Boolean @default(false)
  homeLatitude      Float?
  homeLongitude     Float?
  isSummaryRequired Boolean @default(false)

  managerId       String?

  shifts              Shift[]
  attendanceSessions  AttendanceSession[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model WorkLocation {
  id          String    @id @default(cuid())
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id])
  name        String
  address     String?
  latitude    Float?
  longitude   Float?
  isActive    Boolean   @default(true)

  shifts      Shift[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Shift {
  id          String    @id @default(cuid())
  employeeId  String
  employee    EmployeeProfile @relation(fields: [employeeId], references: [id])
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id])
  workLocationId String?
  workLocation WorkLocation? @relation(fields: [workLocationId], references: [id])
  startAt     DateTime
  endAt       DateTime
  type        ShiftType
  status      ShiftStatus @default(PUBLISHED)
  paidBreakMinutes Int? @default(0)
  unpaidBreakMinutes Int? @default(0)

  attendanceSessions AttendanceSession[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model AttendanceSession {
  id                  String    @id @default(cuid())
  employeeId          String
  employee            EmployeeProfile @relation(fields: [employeeId], references: [id])
  shiftId             String?
  shift               Shift?    @relation(fields: [shiftId], references: [id])
  actualStartAt       DateTime
  actualEndAt         DateTime?
  effectiveStartAt    DateTime
  effectiveEndAt      DateTime?
  wasEarlyCheckIn     Boolean   @default(false)
  totalWorkedMinutes  Int?
  summary             String?

  events              AttendanceEvent[]

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model AttendanceEvent {
  id          String              @id @default(cuid())
  sessionId   String
  session     AttendanceSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  type        AttendanceEventType
  createdAt   DateTime            @default(now())

  locationSnapshot LocationSnapshot?
}

model LocationSnapshot {
  id          String          @id @default(cuid())
  eventId     String          @unique
  event       AttendanceEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  latitude    Float
  longitude   Float
  source      LocationSource
  distanceMeters Float?

  createdAt   DateTime        @default(now())
}
